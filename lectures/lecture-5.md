# Лекция 5

## Проблемы при высокопроизводительных вычислениях

### Стены памяти

![mem-wall.png](images%2Flecture-5%2Fmem-wall.png)

На данный момент CPU и RAM являются отдельным устройствами.

При обращении к данным происходит кэш-промах, требуется обратиться к оперативной памяти и получить эти данные, из-за
чего требуется больше тактов на выполнение операции.

![von-neumann-bottleneck.png](images%2Flecture-5%2Fvon-neumann-bottleneck.png)

Статистика показывает, что разница в пропускной способности памяти и процессора монотонно растёт (красная линия)

Решения:

- 3D-память
- анализ ПВЛ (пространственно временная локализация) R/W операций
- асинхронные R/W с использованием легковесных потоков

### Пространственно-временная локализация обращений в память

![sl-1.png](images%2Flecture-5%2Fsl-1.png)

На рисунке приведены профили 2 разных приложений.

На профиле слева последовательно идет обращение к несоседним адресам.

На профиле справа последовательно происходит обращение к соседним адресам.

![sl-2.png](images%2Flecture-5%2Fsl-2.png)

Можно разместить большой объём данных в ОЗУ, нарезав их на блоки длиной L, и осуществить перебор блоков с определённым
смещением. Таким образом можно локализировать данные и обращаться от операции к операции только по соседним адресам.

Данный способ будет не эффективен, если размер блока L = 1 (ничем не отличается от обращения к несоседним адресам).

![ls-example.png](images%2Flecture-5%2Fls-example.png)

### Временная локализация

Временная локализация позволяет оптимизировать программу за счет выявления адресов, к которым наиболее часто происходит
обращение.

Временная локальность моделируется номерами блоков

![tl.png](images%2Flecture-5%2Ftl.png)

![tl-exampel.png](images%2Flecture-5%2Ftl-exampel.png)

### Профиль перемножения матриц

Профиль перемножения матриц - своего рода статистика, позволяющая определить прирост производительности благодаря
локализациям.

![matrix.png](images%2Flecture-5%2Fmatrix.png)

### Тест APEX-map

Тест APEX-map - карта локализации. На ней можно определить точки, в которых эффективно работает та или иная локализация.

![apex-map.png](images%2Flecture-5%2Fapex-map.png)

- L - хорошая временная и пространственная локальности
- F - хорошая временная локальность и плохая пространственная (размер блока равен 1)
- T - плохая временная локальность (нас не интересуют одни и те же данные несколько раз) и хорошая пространственная (
  имеют большой размер блока)
- G - плохая временная и пространственная локальности

### Увеличение потока обращений процессора к памяти

Можно обеспечить многофазность операций ввода-вывода для порождения множества параллельных обращений к памяти 

- выставление чтения (read issue)
- передача (yield)
- завершение чтения (read complete)

### Метод многофазного чтения

Реализация механизма многофазного чтения - через легковесные потоки, не требующие переключения контекста процессора.

Это не поток (threads) в терминах POSIX, ни задачи ядра Linux (tasks).

Один из методов введения легковесных потоков - применение сопрограмм (coroutines).